# 大学选课系统架构设计文档

## 目录

- [系统概述](#系统概述)
- [架构设计](#架构设计)
  - [系统架构图](#系统架构图)
- [总体架构](#总体架构)
- [核心组件](#核心组件)
  - [CourseSystem实现](#coursesystem实现)
  - [数据模型](#数据模型)
  - [辅助系统](#辅助系统)
- [设计模式应用](#设计模式应用)
  - [Meyer's单例模式](#meyers单例模式)
- [并发控制](#并发控制)
- [安全机制](#安全机制)
- [错误处理设计](#错误处理设计)
  - [错误处理方式](#错误处理方式)
  - [异常层次结构](#异常层次结构)
  - [错误类型分类](#错误类型分类)
  - [资源管理](#资源管理)
- [性能优化设计](#性能优化设计)
  - [当前优化策略](#当前优化策略)
  - [未来性能优化方向](#未来性能优化方向)
- [目录结构](#目录结构)
- [部署要求](#部署要求)
- [未来扩展计划](#未来扩展计划)
- [并发设计意图](#并发设计意图)

## 系统概述

大学选课系统是一个面向高校学生、教师和管理员的综合性教务管理平台，主要功能包括用户管理、课程管理、选课管理、数据持久化、多语言支持等。系统采用面向对象设计方法，使用C++17语言实现。

## 架构设计

### 系统架构图

```
+----------------------------------+
|         用户界面和业务逻辑层       |
|          (CourseSystem类)        |
+----------------------------------+
       |           |             |
       v           v             v
+-------------+ +-----------+ +------------+
| 用户管理模块 | | 课程管理模块| | 选课管理模块|
+-------------+ +-----------+ +------------+
       |           |           |
       v           v           v
+----------------------------------+
|           数据访问层              |
|   (DataManager类、文件操作等)     |
+----------------------------------+
                 |
                 v
+----------------------------------+
|           持久化存储层            |
|           (JSON文件等)           |
+----------------------------------+
```

## 总体架构

大学选课系统采用分层架构设计，主要分为以下几层：

1. **用户界面和业务逻辑层**：负责与用户的交互，显示信息和接收输入，实现系统的核心功能，处理业务规则和流程。
2. **模块化实现**：封装业务逻辑层的实现细节
3. **数据访问层**：负责数据的持久化。

系统的设计遵循面向对象原则，采用了以下设计模式：

- **单一职责原则**：每个类只负责一项职责，如课程管理、用户管理等。
- **组合优于继承**：使用组合关系构建系统，减少继承带来的耦合。

### 当前架构采用的是基于职责分离的设计方法，而不是基于角色分离。这种设计有以下优势：

**单一职责原则**：每个管理模块只负责一种核心业务实体的管理

- UserManager 专注于用户数据管理
- CourseManager 专注于课程数据管理
- EnrollmentManager 专注于选课关系管理

**降低耦合度**：如果按角色（学生、教师、管理员）划分，各模块之间会产生大量交叉引用和依赖

**代码重用**：避免在不同角色模块中重复实现相似的功能

**因此按功能模块（用户管理、课程管理、选课管理）划分而非按角色（管理员、教师、学生）划分是合理的，这种设计符合单一职责原则，降低了系统耦合度，便于维护和扩展。**

## 核心组件

1. **用户界面与业务逻辑层**（在CourseSystem类中实现）
   - 提供命令行交互界面
   - 实现多语言菜单和提示信息
   - 处理用户输入和输出显示
   - 交互式菜单系统，支持不同用户类型的菜单显示
   - 系统核心控制器
   - 用户权限控制
   - 业务规则实施
2. **功能模块层**
   - 用户管理模块：用户创建、修改和查询 (UserManager)
   - 课程管理模块：课程创建、修改和查询 (CourseManager)
   - 选课管理模块：选课、退课和选课状态查询 (EnrollmentManager)
3. **数据访问层**
   - DataManager类：统一数据访问接口
   - 数据序列化和反序列化（json解析库）
   - 安全的文件读写操作
4. **持久化存储层**
   - JSON格式文件存储

### CourseSystem实现

CourseSystem类实现了以下核心功能：

1. **系统生命周期管理**
   - 初始化系统
   - 系统运行
   - 系统关闭和资源释放
2. **用户界面功能**
   - 菜单显示和处理
   - 用户输入收集和验证
   - 结果展示和格式化
3. **用户会话管理**
   - 用户登录和认证
   - 会话状态维护
   - 用户注销
4. **权限控制**
   - 基于用户类型的权限检查
   - 不同角色的功能菜单展示
5. **功能调用**
   - 用户管理功能
   - 课程管理功能
   - 选课管理功能

这种综合性设计使CourseSystem类成为整个系统的中央控制器。

### 数据模型

系统的核心数据模型包括：

1. **User**（及其子类：Student、Teacher、Admin）
   - 包含用户基本信息和认证逻辑
   - 基于SHA-256的密码哈希实现
   - 随机盐值生成与存储
   - 实现移动语义以优化对象传递
   - 通过继承，基类定义虚函数支持多态
2. **Course**
   - 课程信息和容量管理
   - 提供学生选课状态查询
   - 高效的学生名单管理（基于哈希表）
   - 支持课程容量动态管理
   - 实现移动语义以优化对象传递
3. **Enrollment**
   - 记录学生选课关系和状态
   - 自动记录选课时间
   - 实现移动语义以优化对象传递

### 辅助系统

1. **日志系统**
   - 支持多级别日志（debug、info、warning、error、critical）
   - 日志级别过滤：通过设置日志级别，系统只记录达到或超过该级别的日志
   - 环境适配：可根据环境需求调整日志详细程度（开发环境使用DEBUG级别，生产环境使用ERROR级别）
   - 级别传播机制：高级别日志自动写入所有低级别日志文件
   - 线程安全设计：使用互斥锁保护日志写入操作，防止多线程环境下的日志混乱

2. **国际化系统**
   - I18nManager类：多语言资源管理
   - 基于JSON的语言资源文件
   - 性能优化：高频调用的getText()方法采用无锁读取设计，提升UI响应速度
   - 格式化支持：实现类似"{0}, {1}"的参数替换格式化功能，将占位符替换为具体的值

3. **输入验证系统**
   - InputValidator类：输入数据验证
   - 提供统一验证接口
   - 支持整数、浮点数等多种数据类型验证
   - 基于正则表达式的输入格式验证

## 设计模式应用

### Meyer's单例模式

用于确保系统中只有一个特定类的实例，使用于以下组件：

- CourseSystem类：确保系统全局唯一
- Logger类：确保单一日志管理点
- I18nManager类：确保统一语言资源管理
- UserManager类：确保用户数据统一管理
- CourseManager类：确保课程数据统一管理
- EnrollmentManager类：确保选课数据统一管理
- DataManager类：确保数据访问统一管理

 原理：通过私有化默认构造函数，在公有成员函数内定义静态局部对象，利用静态局部对象多次进入只初始化一次的特性实现单例模式。

## 并发控制

系统采用以下机制确保在多用户并发环境中的数据一致性：

1. **互斥锁（Mutex）**
   - 使用std::mutex保护共享资源
   - 各管理类（UserManager、CourseManager、EnrollmentManager、DataManager、I18nManager、Logger）均有各自的互斥锁
   - 数据访问时加锁，确保线程安全
2. **RAII锁管理**
   - 自定义LockGuard：扩展了标准std::lock_guard功能，增加了超时控制和状态检查
   - 锁获取超时处理：超时时抛出LOCK_TIMEOUT异常，避免无限阻塞
   - 状态检查：提供isLocked()方法检查锁状态
3. **线程安全的文件操作**
   - **原子性文件写入**：先写入临时文件再重命名，确保文件写入的原子性和完整性
   - **并发读写保护**：文件读写操作受互斥锁保护，确保数据完整性
   
## 安全机制

1. **身份认证**
   - SHA-256密码哈希存储
   - 随机盐值防范彩虹表攻击
   - OpenSSL库实现的加密功能
   注：预置用户密码采用纯哈希加密，但是预置用户的密码一经修改，加密方式变为哈希+盐值，其它用户始终使用密码加盐值加密
2. **权限控制**
   - 基于角色的访问控制
   - CourseSystem中进行敏感操作权限检查
3. **输入验证**
   - 通过InputValidator进行输入格式验证
   - 正则表达式验证输入格式
   - 防止非法输入
4. **安全的文件操作**
   - 检查文件路径和权限
   - 保护敏感数据文件（密码）
   - 临时文件原子写入：使用临时文件写入后重命名的方式，确保数据完整性

## 错误处理设计

### 错误处理方式

1. **返回值错误处理**
   - 用于可恢复的常规错误
   - 通过布尔值返回错误状态
   - 日志记录错误情况
2. **异常处理**
   - 用于严重错误或不可恢复的错误
   - 统一使用`SystemException`类
   - 多层异常捕获机制
   - 主函数中完整的异常捕获保证程序优雅终止

### 异常层次结构

使用`std::runtime_error`作为异常的基类

### 错误类型分类

系统错误类型分为以下几类：

1. **数据错误**
   - `DATA_NOT_FOUND`：请求的数据不存在
   - `DATA_ALREADY_EXISTS`：尝试创建已存在的数据
   - `DATA_INVALID`：数据格式或内容无效

2. **文件错误**
   - `FILE_NOT_FOUND`：文件不存在
   - `FILE_ACCESS_DENIED`：文件访问被拒绝
   - `FILE_CORRUPTED`：文件已损坏

3. **权限错误**
   - `PERMISSION_DENIED`：操作权限不足
   - `AUTHENTICATION_FAILED`：认证失败

4. **业务逻辑错误**
   - `COURSE_FULL`：课程已满
   - `ALREADY_ENROLLED`：已经选修此课程
   - `NOT_ENROLLED`：未选修此课程

5. **并发错误**
   - `LOCK_TIMEOUT`：锁定超时
   - `LOCK_FAILURE`：锁定失败
   - `CONCURRENT_MODIFICATION`：并发修改冲突

6. **其他错误**
   - `UNKNOWN_ERROR`：未知错误
   - `INITIALIZATION_FAILED`：初始化失败
   - `INVALID_INPUT`：无效输入
   - `OPERATION_FAILED`：操作失败

### 资源管理

系统使用RAII（资源获取即初始化）模式管理资源，确保在异常情况下也能正确释放资源：

- `LockGuard`类自动管理互斥锁的获取和释放
- 智能指针（`unique_ptr`）管理动态分配的对象

## 性能优化设计

### 当前优化策略

- 使用哈希表(unordered_map)提升查询性能
- 智能指针管理内存，避免内存泄漏
- 移动语义减少不必要的对象复制
- 对共享资源使用互斥锁保护
- 预编译头文件(pch.h)加速编译
- 使用引用而非拷贝减少不必要的对象复制
- 读写平衡：高频调用的方法（如I18nManager::getText()）采用无锁读取设计，牺牲极小的一致性风险换取显著性能提升
- 精细化锁粒度：精确控制互斥锁的作用范围，最小化线程阻塞时间

### 未来性能优化方向

为进一步提升系统性能，未来可考虑实现以下优化策略：

#### 对象池模式

在高并发场景下，可实现对象池模式来减少频繁创建和销毁对象的开销：

- StudentPool：学生对象池
- TeacherPool：教师对象池
- CoursePool：课程对象池
- EnrollmentPool：选课记录对象池

#### 其他可能的优化

- 懒加载策略：按需加载数据
- 缓存机制：缓存热点数据
- 批量处理：减少IO操作频率

## 目录结构

   ```
   project/
   ├── build/                  # 用户编译时创建
   |   └── ...
   ├── CMakeLists.txt          # 项目构建配置
   ├── include/                # 头文件目录
   │   ├── model/              # 数据模型
   │   ├── manager/            # 管理器类
   │   ├── system/             # 系统类
   │   ├── util/               # 工具类，辅助系统
   │   └── pch.h               # 预编译头文件
   ├── src/                    # 源文件目录
   │   ├── model/              # 数据模型实现
   │   ├── manager/            # 管理器类实现
   │   ├── system/             # 系统类实现
   │   ├── util/               # 工具类和辅助系统实现
   │   └── main.cpp            # 主函数
   ├── data/                   # 数据文件目录
   │   ├── Chinese.json        # 中文语言文件
   │   ├── English.json        # 英文语言文件
   │   ├── users.json          # 用户数据
   │   ├── courses.json        # 课程数据
   │   └── enrollment.json     # 选课数据
   ├── log/                    # 日志文件目录（自动创建）
   ├── docs/                   # 文档目录
   │   ├── system_arch.md      # 系统架构文档
   │   └── user_regulation.md  # 运行规范文档
   ├── nlohmann/               # JSON解析库
   │   └── json.hpp            # JSON解析库（单头文件的json解析库）
   ├── LICENSE                 # 许可证文件
   └── README.md               # README.md
   ```
## 部署要求

 **本项目的开发环境：Rocky Linux 9.5（5.14.0-503.14.1.el9_5.x86_64内核版本）**

- C++17兼容的编译器(GCC 8+/Clang 7+/MSVC 19.14+)
- CMake 3.16或更高版本
- 以下依赖库：
  - **OpenSSL**（必须安装，用于加密）
  - nlohmann/json（已包含在源码中）(使用单头文件的json解析库，通过预编译头文件减少编译时间)

## 未来扩展计划

1. **GUI界面**
   - 桌面GUI
   - 更友好的用户交互体验

2. **网络功能**
   - 客户端-服务器架构
   - 多用户同时在线支持

3. **高级功能**
   - 自动排课
   - 一键选课

4. **数据备份与恢复机制**

## 并发设计意图

虽然当前的用户交互界面是单用户的命令行环境，但系统的并发设计主要是为了：

 **为未来扩展到多用户网络环境做准备**
 - "未来扩展计划"包括"客户端-服务器架构"和"多用户同时在线支持"

**这种前瞻性的设计使系统在未来扩展时无需大规模重构，同时也提高了当前系统的稳定性和可靠性**